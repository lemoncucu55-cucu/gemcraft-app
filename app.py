import streamlit as st
import pandas as pd

# ==========================================
# 1. æ ¸å¿ƒé‚è¼¯å€ (å‡½å¼)
# ==========================================

def check_and_fill_ids(df):
    """
    è‡ªå‹•ç·¨è™Ÿé‚è¼¯ï¼š
    æª¢æŸ¥è¡¨æ ¼ï¼Œå¦‚æœæœ‰ã€Œå·²é¸åˆ†é¡ã€ä½†ã€Œæ²’ç·¨è™Ÿã€çš„é …ç›®ï¼Œ
    è‡ªå‹•ä¾ç…§åˆ†é¡çµ¦äºˆæµæ°´è™Ÿ (ä¾‹å¦‚: ST0004)
    """
    prefix_map = {
        'å¤©ç„¶çŸ³': 'ST',  # Stone
        'é…ä»¶': 'AC',    # Accessory
        'è€—æ': 'OT',    # Others
    }

    # ç¢ºä¿ç´¢å¼•æ˜¯ä¹¾æ·¨çš„ï¼Œé¿å…æŠ“ä¸åˆ°æ–°çš„ä¸€è¡Œ
    df = df.reset_index(drop=True)

    for index, row in df.iterrows():
        # æª¢æŸ¥ç·¨è™Ÿæ˜¯å¦ç‚ºç©º
        is_id_empty = pd.isna(row['ç·¨è™Ÿ']) or row['ç·¨è™Ÿ'] == '' or row['ç·¨è™Ÿ'] is None
        category = row.get('åˆ†é¡')
        
        # åªæœ‰ç•¶ã€Œç·¨è™Ÿæ˜¯ç©ºçš„ã€ä¸”ã€Œåˆ†é¡å·²é¸æ“‡ã€æ™‚ï¼Œæ‰é€²è¡Œè£œè™Ÿ
        if is_id_empty and category in prefix_map:
            prefix = prefix_map[category]
            
            # æ‰¾å‡ºç›®å‰è©²åˆ†é¡æœ€å¤§çš„è™Ÿç¢¼
            # å…ˆç¯©é¸å‡ºåŒåˆ†é¡çš„ç·¨è™Ÿ
            existing_ids = df[df['ç·¨è™Ÿ'].astype(str).str.startswith(prefix, na=False)]['ç·¨è™Ÿ']
            
            max_num = 0
            for eid in existing_ids:
                try:
                    # å–å‡ºå¾Œé¢çš„æ•¸å­—éƒ¨åˆ† (ST0001 -> 1)
                    num = int(eid[2:]) 
                    if num > max_num:
                        max_num = num
                except:
                    pass
            
            # ç”Ÿæˆæ–°è™Ÿç¢¼ (æœ€å¤§è™Ÿ + 1)ï¼Œä¸¦è£œé›¶è‡³4ä½æ•¸
            new_id = f"{prefix}{str(max_num + 1).zfill(4)}"
            
            # å¯«å›è¡¨æ ¼
            df.at[index, 'ç·¨è™Ÿ'] = new_id
            
    return df

# ==========================================
# 2. è¨­å®šèˆ‡è³‡æ–™åº«åˆå§‹åŒ–
# ==========================================

if 'inventory' not in st.session_state:
    # é è¨­è³‡æ–™ (å–®ä½å·²çµ±ä¸€ç‚ºã€Œé¡†ã€)
    data = {
        'ç·¨è™Ÿ': ['ST0001', 'ST0002', 'ST0003', 'AC0001', 'OT0001'],
        'åç¨±': ['ç´«æ°´æ™¶ 8mm', 'ç²‰æ™¶ 8mm', 'ç™½æ°´æ™¶ 6mm', '925ç´”éŠ€éš”ç ', 'æ—¥æœ¬å½ˆåŠ›ç·š'],
        'åˆ†é¡': ['å¤©ç„¶çŸ³', 'å¤©ç„¶çŸ³', 'å¤©ç„¶çŸ³', 'é…ä»¶', 'è€—æ'],
        'é€²è²¨ç¸½åƒ¹': [500, 450, 300, 1500, 200],
        'é€²è²¨æ•¸é‡(é¡†)': [40, 40, 60, 100, 1], 
        'åº«å­˜(é¡†)': [80, 120, 300, 100, 10], 
    }
    df = pd.DataFrame(data)
    # è¨ˆç®—å–®é¡†æˆæœ¬ (é˜²å‘†ï¼šé¿å…é™¤ä»¥0)
    df['å–®é¡†æˆæœ¬'] = df['é€²è²¨ç¸½åƒ¹'] / df['é€²è²¨æ•¸é‡(é¡†)'].replace(0, 1)
    st.session_state['inventory'] = df

if 'current_design' not in st.session_state:
    st.session_state['current_design'] = []

# ==========================================
# 3. UI ä»‹é¢è¨­è¨ˆ
# ==========================================

st.set_page_config(page_title="GemCraft æˆæœ¬è¨ˆç®—æ©Ÿ", layout="wide")
st.title("ğŸ’ GemCraft æˆæœ¬è¨ˆç®—æ©Ÿ")

page = st.sidebar.radio("åŠŸèƒ½é¸å–®", ["ğŸ“¦ åº«å­˜ç®¡ç†", "ğŸ§® è¨­è¨ˆèˆ‡æˆæœ¬è¨ˆç®—"])

# ------------------------------------------
# é é¢ A: åº«å­˜ç®¡ç† (Inventory)
# ------------------------------------------
if page == "ğŸ“¦ åº«å­˜ç®¡ç†":
    st.header("åº«å­˜è³‡æ–™åº«")
    st.info("ğŸ’¡ æ–°å¢å•†å“æ­¥é©Ÿï¼š1.è¼¸å…¥åç¨± -> 2.é¸æ“‡åˆ†é¡ -> 3.é»æ“Šç©ºç™½è™•ï¼Œç³»çµ±å³æœƒè‡ªå‹•ç”¢ç”Ÿç·¨è™Ÿã€‚")

    current_df = st.session_state['inventory']

    # é¡¯ç¤ºç·¨è¼¯å™¨
    edited_df = st.data_editor(
        current_df.sort_values(by='ç·¨è™Ÿ'), # ä¾ç…§ç·¨è™Ÿæ’åºé¡¯ç¤º
        num_rows="dynamic",
        use_container_width=True,
        hide_index=True, # éš±è—æœ€å·¦é‚Šçš„æ•¸å­—ç´¢å¼•
        # æŒ‡å®šæ¬„ä½é †åº
        column_order=("ç·¨è™Ÿ", "åç¨±", "åˆ†é¡", "é€²è²¨ç¸½åƒ¹", "é€²è²¨æ•¸é‡(é¡†)", "åº«å­˜(é¡†)", "å–®é¡†æˆæœ¬"),
        # è¨­å®šå”¯è®€æ¬„ä½ (ç·¨è™Ÿç”±ç³»çµ±ç”¢ç”Ÿï¼Œæˆæœ¬ç”±å…¬å¼ç®—)
        disabled=["ç·¨è™Ÿ", "å–®é¡†æˆæœ¬"] 
    )

    # åµæ¸¬è³‡æ–™è®Šå‹•
